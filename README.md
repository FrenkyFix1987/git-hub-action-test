# Image Upload App - Complete Azure Solution

A complete solution for image uploading using Flask and Azure Blob Storage, with Terraform infrastructure as code.

## 🏗️ Project Structure

```
image-app/
├── terraform/           # Infrastructure as Code
│   ├── main.tf         # Terraform provider configuration
│   ├── variables.tf    # Variable definitions
│   ├── resources.tf    # Azure resource definitions
│   ├── outputs.tf      # Output values
│   ├── terraform.tfvars.example
│   └── README.md       # Terraform documentation
├── webapp/             # Flask Web Application
│   ├── app.py         # Main Flask application
│   ├── requirements.txt
│   ├── templates/
│   │   └── index.html # Web interface
│   ├── Dockerfile     # Container configuration
│   ├── .env.example   # Environment template
│   └── README.md      # Webapp documentation
├── .gitignore
└── README.md          # This file
```

## 🚀 Quick Start Guide

### 1. Provision Azure Infrastructure

```bash
# Navigate to terraform directory
cd terraform

# Configure variables
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with your preferences

# Initialize and deploy
terraform init
terraform plan
terraform apply

# Generate webapp configuration
terraform output -raw env_file_content > ../webapp/.env
```

### 2. Deploy Web Application

```bash
# Navigate to webapp directory
cd ../webapp

# Install dependencies
pip install -r requirements.txt

# Run the application
python app.py
```

### 3. Access Application

Visit `http://localhost:5000` to upload and view images.

## 📋 Prerequisites

### For Infrastructure (Terraform):
- Azure CLI installed and authenticated
- Terraform v1.0+ installed
- Azure subscription with contributor access

### For Web Application:
- Python 3.10+ (3.13+ preferred)
- Azure Storage Account (created by Terraform)

## 🎯 Features

### Infrastructure (Terraform)
- ✅ Azure Resource Group
- ✅ Azure Storage Account with configurable tiers
- ✅ Blob containers for uploads and thumbnails
- ✅ Application Insights for monitoring
- ✅ Security best practices (TLS 1.2, CORS, retention policies)
- ✅ Comprehensive outputs for application configuration

### Web Application (Flask)
- ✅ Upload JPG, JPEG, PNG images (max 10MB)
- ✅ Responsive image gallery with thumbnails
- ✅ Secure file validation and handling
- ✅ Support for public and private blob containers
- ✅ SAS token generation for secure access
- ✅ Modern UI with CSS Grid
- ✅ Docker support for containerized deployment

## 🛡️ Security Features

### Infrastructure Security
- TLS 1.2 minimum for storage accounts
- Configurable container access levels
- Resource tagging for governance
- Soft delete and versioning enabled

### Application Security
- File extension and MIME type validation
- Secure filename generation with UUIDs
- No hardcoded secrets
- Environment-based configuration
- SAS tokens for private container access

## 📊 Architecture

```
┌─────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Browser   │───▶│  Flask Web App   │───▶│ Azure Blob      │
│             │◀───│  (Port 5000)     │◀───│ Storage         │
└─────────────┘    └──────────────────┘    └─────────────────┘
                            │
                            ▼
                   ┌──────────────────┐
                   │ Application      │
                   │ Insights         │
                   └──────────────────┘
```

## 🔧 Configuration Options

### Terraform Variables

| Variable | Description | Default | Options |
|----------|-------------|---------|---------|
| `location` | Azure region | "East US" | Any Azure region |
| `environment` | Environment name | "dev" | dev, staging, prod |
| `storage_account_tier` | Storage performance | "Standard" | Standard, Premium |
| `blob_container_access_type` | Container access | "private" | private, blob, container |

### Application Environment

```env
# Azure Storage (auto-generated by Terraform)
AZURE_STORAGE_CONNECTION_STRING=...
AZURE_BLOB_CONTAINER=uploads
AZURE_PUBLIC_CONTAINER=false

# Flask Configuration
FLASK_SECRET_KEY=your-secret-key
FLASK_DEBUG=false
```

## 🚀 Deployment Options

### Local Development
1. Use Terraform to create Azure resources
2. Run Flask app locally with generated configuration

### Docker Deployment
```bash
cd webapp
docker build -t image-upload-app .
docker run -p 5000:5000 --env-file .env image-upload-app
```

### Azure App Service
1. Deploy infrastructure with Terraform
2. Deploy webapp to Azure App Service
3. Configure environment variables from Terraform outputs

### Container Instances
```bash
# Build and push to Azure Container Registry
# Deploy to Azure Container Instances
```

## 📚 Documentation

- **[Terraform Documentation](terraform/README.md)** - Infrastructure provisioning guide
- **[Webapp Documentation](webapp/README.md)** - Flask application guide

## 🔍 Troubleshooting

### Infrastructure Issues
```bash
cd terraform
terraform refresh
terraform plan
```

### Application Issues
```bash
cd webapp
python app.py  # Check startup logs
```

### Common Problems

**Terraform state issues:**
- Check Azure CLI authentication: `az account show`
- Verify subscription access: `az account list`

**Storage connection issues:**
- Verify connection string format
- Check container exists in Azure Portal
- Validate access keys are current

**Application errors:**
- Check `.env` file exists in webapp directory
- Verify Python dependencies installed
- Review application logs for specific errors

## 🧹 Cleanup

```bash
# Destroy all Azure resources
cd terraform
terraform destroy
```

## 📈 Monitoring and Observability

- **Application Insights** - Performance and error monitoring
- **Azure Monitor** - Infrastructure metrics
- **Storage Analytics** - Blob access patterns
- **Flask Logging** - Application-level debugging

## 🔄 CI/CD Integration

### GitHub Actions Example

```yaml
name: Deploy Image Upload App

on:
  push:
    branches: [main]

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
      - name: Terraform Apply
        run: |
          cd terraform
          terraform init
          terraform apply -auto-approve

  deploy:
    needs: terraform
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Azure App Service
        # Add your deployment steps
```

## 🤝 Contributing

1. Fork the repository
2. Create a feature branch
3. Make changes to `terraform/` or `webapp/` as needed
4. Test locally
5. Submit a pull request

## 📄 License

MIT License - see LICENSE file for details

## Azure Storage Setup

### 1. Create Storage Account

1. Go to [Azure Portal](https://portal.azure.com)
2. Create a new Storage Account
3. Note the account name and access key

### 2. Get Connection String

**Option A: Connection String (Recommended)**
1. Go to your Storage Account → Access Keys
2. Copy the connection string
3. Set `AZURE_STORAGE_CONNECTION_STRING` in `.env`

**Option B: Account Name + Key**
1. Set `AZURE_STORAGE_ACCOUNT` to your storage account name
2. Set `AZURE_STORAGE_KEY` to your access key

### 3. Container Configuration

**Public Container (easier setup):**
1. Create a container in your storage account
2. Set container access level to "Blob (anonymous read access for blobs only)"
3. Set `AZURE_PUBLIC_CONTAINER=true` in `.env`

**Private Container (more secure):**
1. Create a container with private access
2. Set `AZURE_PUBLIC_CONTAINER=false` in `.env`
3. App will generate SAS tokens for image access

## Project Structure

```
image-app/
├── app.py                 # Main Flask application
├── requirements.txt       # Python dependencies
├── .env.example          # Environment variables template
├── .env                  # Your environment variables (create this)
├── templates/
│   └── index.html        # Main page template
├── Dockerfile            # Docker configuration (optional)
└── README.md            # This file
```

## API Endpoints

- `GET /` - Home page with upload form and image gallery
- `POST /upload` - Handle image upload to Azure Blob Storage

## Security Features

- File extension validation (only .jpg, .jpeg, .png)
- MIME type validation (image/jpeg, image/png)
- File size limit (10MB)
- Secure filename generation with UUID
- No hardcoded secrets
- SAS tokens for private container access
- HTTPS-only SAS URLs

## Error Handling

- Invalid file types → 400 with flash message
- File too large → 400 with flash message  
- Azure connection errors → Flash message with retry suggestion
- General exceptions → Graceful error handling

## Development

### Local Development

```bash
# Install in development mode
pip install -e .

# Run with debug mode
export FLASK_DEBUG=true  # Linux/Mac
set FLASK_DEBUG=true     # Windows
python app.py
```

### Testing Azure Connection

The app will test Azure connectivity on startup and exit with an error if misconfigured.

## Docker Deployment (Optional)

```bash
# Build image
docker build -t image-upload-app .

# Run container
docker run -p 5000:5000 --env-file .env image-upload-app
```

## Production Deployment

### Environment Variables

Set these in your production environment:

```env
AZURE_STORAGE_CONNECTION_STRING=<your-connection-string>
AZURE_BLOB_CONTAINER=uploads
AZURE_PUBLIC_CONTAINER=false
FLASK_SECRET_KEY=<strong-random-secret>
FLASK_DEBUG=false
```

### Using Gunicorn

```bash
pip install gunicorn
gunicorn --bind 0.0.0.0:5000 app:app
```

### Azure App Service Deployment

1. Create an Azure App Service (Python 3.10+)
2. Configure environment variables in App Service settings
3. Deploy code via Git, GitHub Actions, or ZIP deployment
4. Set startup command: `gunicorn --bind 0.0.0.0:8000 app:app`

## Troubleshooting

### Common Issues

**"Azure Storage credentials not configured"**
- Check your `.env` file exists and has correct values
- Verify connection string format
- Ensure no extra spaces in environment variables

**"Import flask could not be resolved"**
- Activate your virtual environment
- Install requirements: `pip install -r requirements.txt`

**Images not loading**
- Check container exists in Azure Storage
- Verify `AZURE_PUBLIC_CONTAINER` setting matches your container access level
- For private containers, ensure account key is correct for SAS generation

**File upload fails**
- Check file size (max 10MB)
- Verify file extension (.jpg, .jpeg, .png)
- Check Azure Storage account permissions

### Logs

Check application logs for detailed error information:

```bash
python app.py
# Look for startup messages and error details
```

## License

MIT License - see LICENSE file for details
